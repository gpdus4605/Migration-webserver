# 요청 시간에서 YYYY-MM-DD 형식의 날짜를 추출하기 위한 map을 정의합니다.
map $time_iso8601 $logdate {
    '~(\d{4}-\d{2}-\d{2})'    $1;
    default    '';
}

# JSON 형식의 로그 포맷을 정의합니다.
log_format json_analytics escape=json '{'
    '"timestamp": "$time_iso8601",'
    '"client_ip": "$remote_addr",'
    '"request_method": "$request_method",'
    '"request_uri": "$request_uri",'
    '"status": "$status",'
    '"body_bytes_sent": "$body_bytes_sent",'
    '"http_referer": "$http_referer",'
    '"user_agent": "$http_user_agent",'
    '"request_time": "$request_time",'
    '"upstream_response_time": "$upstream_response_time",'
    '"x_forwarded_for": "$http_x_forwarded_for"'
'}';

server {
    listen 80;
    server_name www.gpdus4605.site;

    # access_log 지시어를 수정하여 날짜별 로그 파일에 JSON 포맷으로 기록합니다.
    access_log /var/log/nginx/access-$logdate.log json_analytics;

    # API 경로 요청은 백엔드 API 서버로 프록시합니다.
    location /api/ {
        proxy_pass http://api:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        # CloudFront가 보내준 원래 프로토콜(https)을 백엔드에 알려줍니다.
        proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    }

    # 그 외의 모든 요청은 프론트엔드 정적 파일을 제공합니다.
    location / {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }
}
